{% extends 'base.html' %}
{% load mptt_tags %}
{% load guardian_tags %}
{% load static %}

{% block title %}My folders{% endblock %}
{% block content %}
    <h1>My Folders</h1>
    <div class="module">
        <ul>
            {% recursetree folders %}
                {% get_obj_perms request.user for node as "treeitem_perms" %}
                        {% if "view_treeitem" in treeitem_perms %}
                              <li>
                              {% if node.content_type.name == 'document'%}
                                    <img src="{% static 'img/doc.png' %}" />
                                    {{ node.content_object }}
                            <a href="#
{#                                {% url "document_open"  node.id %}#}
    "                       >
                                {% if "change_treeitem" in treeitem_perms %}
                                    Edit doc(Role Editor)
                                {% endif %}
                                 {% if "delete_treeitem" in treeitem_perms %}
                                    View doc(Role Viewer)
                                {% endif %}
                            </a>
                        {% else %}
                          <img src="{% static 'img/folder.png' %}" />
                             {{ node.content_object }}
                            <a href="{% url "document_create"  node.id %}">Create document</a>
                        {% endif %}
                              </br>
                            {% if not node.is_leaf_node %}
                                <ul>
                                    {{ children }}
                                </ul>
                            {% endif %}
                            </li>
                    {% endif %}
            {% endrecursetree %}
        </ul>



{#    {#}
{#  id          : "string" // will be autogenerated if omitted#}
{#  text        : "string" // node text#}
{#  icon        : "string" // string for custom#}
{#  state       : {#}
{#    opened    : boolean  // is the node open#}
{#    disabled  : boolean  // is the node disabled#}
{#    selected  : boolean  // is the node selected#}
{#  },#}
{#  children    : []  // array of strings or objects#}
{#  li_attr     : {}  // attributes for the generated LI node#}
{#  a_attr      : {}  // attributes for the generated A node#}




{##}
{##}
{#    <ul>#}
{#    {% recursetree folders %}#}
{#        <li>#}
{#            {{ node.content_object  }}#}
{#        </br>#}
{#            {% if not node.is_leaf_node %}#}
{#                <ul class="children">#}
{#                    {{ children }}#}
{#                </ul>#}
{#            {% endif %}#}
{#        </li>#}
{#    {% endrecursetree %}#}
{#</ul>#}


{#    {% drilldown_tree_for_node genre as drilldown cumulative count courses.TreeItem.content_object in game_count %}#}
{#{% for node,structure in drilldown|tree_info %}#}
{#    {% if structure.new_level %}<ul><li>{% else %}</li><li>{% endif %}#}
{#    {% if node == genre %}#}
{#        <strong>{{ node.name }}</strong>#}
{#    {% else %}#}
{#        <a href="">{{ node.name }}</a>#}
{#        {% if node.parent_id == genre.pk %}({{ node.game_count }}){% endif %}#}
{#    {% endif %}#}
{#    {% for level in structure.closed_levels %}</li></ul>{% endfor %}#}
{#{% endfor %}#}


{#{% full_tree_for_model  courses.TreeItem as folders %}#}
{#     {% for item,structure in folders|tree_info %}#}
{#        {% if structure.new_level %}<ul><li>{% else %}</li><li>{% endif %}#}
{#            {{ item.content_object }}#}
{#        {% for level in structure.closed_levels %}</li></ul>{% endfor %}#}
{#{% endfor %}#}



        <p>
            <a href="{% url "folder_create" %}" class="button">Create new Folder</a>
        </p>
    </div>

     <div id="jstree_demo_div" style="overflow:auto; border:1px solid silver; min-height:300px; "></div>

{% endblock %}






{% block domready %}
{# Формирование Json для дерева#}
    var json =[
                {% recursetree folders %}
                {
                    "id": "{{ node.id }}",
                    "text": "{{ node.content_object }}",
{#                    "icon": '',#}
                    "children": [{{ children }}]
                }{% if node.get_next_sibling %},{% endif %}
                {% endrecursetree %}
            ]

var jsonCustom =[
        {% recursetree folders %}
                {% get_obj_perms request.user for node as "treeitem_perms" %}
                    {% if "view_treeitem" in treeitem_perms %}
                        {
                              "id": "{{ node.id }}",
                              "text": "{{ node.content_object }}",
                             {% if node.content_type.name == 'document'%}
                                 "icon":'{% static 'img/doc.png' %}',
                             {% else %}
                                 "icon":'{% static 'img/folder.png' %}',
                             {% endif %}

                             "children": [{{ children }}]
                          }
                         {% if node.get_next_sibling %},{% endif %}
                    {% endif %}


            {% endrecursetree %}
    ]

    console.log({{ js | safe }})

$('#jstree_demo_div').jstree({ 'core' : {
        "animation": 0,
        "check_callback": true,
        "themes": {"stripes": true, "icons": true },
        'data': {{ js | safe }},
    },
        "types" : {
    "#" : {
      "max_children" : 1,
      "max_depth" : 4,
      "valid_children" : ["root"]
    },
    "root" : {
      "icon" : "{% static 'img/folder.png' %}",
      "valid_children" : ["default"]
    },
    "default" : {
      "valid_children" : ["default","file"]
    },
    "file" : {
      "icon" : "{% static 'img/folder.png' %}",
      "valid_children" : []
    }
  },
  "plugins" : [
    "contextmenu", "dnd", "search",
    "state", "types", "wholerow"
  ]
    });
{% endblock %}